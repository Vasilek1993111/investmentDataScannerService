# ===========================================
# ОСНОВНАЯ КОНФИГУРАЦИЯ
# ===========================================
spring.application.name=investment-data-scanner-service

# ===========================================
# ОБЩИЕ НАСТРОЙКИ ДЛЯ ВСЕХ ПРОФИЛЕЙ
# ===========================================
# Tinkoff API - базовые настройки
tinkoff.api.base-url=https://invest-public-api.tinkoff.ru/rest
tinkoff.api.timeout=30000

# Datasource (PostgreSQL) - общие настройки
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA / Hibernate - общие настройки
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.default_schema=invest

# Оптимизация JPA для пакетной обработки
spring.jpa.properties.hibernate.jdbc.batch_size=100
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true

# Настройки транзакций
spring.jpa.properties.hibernate.connection.autocommit=false

# Application timezone
app.timezone=Europe/Moscow

# ===========================================
# TINKOFF API - ПОДДЕРЖКА РАЗНЫХ ТОКЕНОВ
# ===========================================
# Поддержка как продакшн, так и тестовых токенов
tinkoff.api.token=${TINKOFF_API_TOKEN:${T_INVEST_TEST_TOKEN:${T_INVEST_PROD_TOKEN}}}

# ===========================================
# БАЗА ДАННЫХ - ПОДДЕРЖКА РАЗНЫХ ОКРУЖЕНИЙ
# ===========================================
# Поддержка как продакшн, так и тестовых БД
spring.datasource.url=${DB_URL:${SPRING_DATASOURCE_TEST_URL:${SPRING_DATASOURCE_PROD_URL:jdbc:postgresql://localhost:5434/postgres}}}
spring.datasource.username=${DB_USERNAME:${SPRING_DATASOURCE_TEST_USERNAME:${SPRING_DATASOURCE_PROD_USERNAME:postgres}}}
spring.datasource.password=${DB_PASSWORD:${SPRING_DATASOURCE_TEST_PASSWORD:${SPRING_DATASOURCE_PROD_PASSWORD:123password123}}}

# ===========================================
# ПУЛ СОЕДИНЕНИЙ - БАЗОВЫЕ НАСТРОЙКИ
# ===========================================
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.leak-detection-threshold=60000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.keepalive-time=30000

# ===========================================
# ЛОГИРОВАНИЕ - БАЗОВЫЕ НАСТРОЙКИ
# ===========================================
logging.level.org.springframework.jdbc=WARN
logging.level.com.example.investmentdatascannerservice.service.QuoteScannerService=INFO
logging.level.com.example.investmentdatascannerservice.service.InstrumentPairService=INFO
logging.level.com.example.investmentdatascannerservice.controller.QuoteWebSocketController=INFO
logging.level.com.example.investmentdatascannerservice.controller.PairWebSocketController=INFO

# ===========================================
# JACKSON CONFIGURATION
# ===========================================
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.deserialization.fail-on-unknown-properties=false

# ===========================================
# ACTUATOR CONFIGURATION
# ===========================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus,circuitbreakers
management.endpoint.health.show-details=always
management.prometheus.metrics.export.enabled=true

# ===========================================
# RESILIENCE4J CONFIGURATION
# ===========================================
resilience4j.circuitbreaker.instances.tinvest-api.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.tinvest-api.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.tinvest-api.sliding-window-size=10
resilience4j.circuitbreaker.instances.tinvest-api.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.tinvest-api.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.tinvest-api.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.tinvest-api.slow-call-rate-threshold=50
resilience4j.circuitbreaker.instances.tinvest-api.slow-call-duration-threshold=5s

# ===========================================
# CACHE CONFIGURATION
# ===========================================
spring.cache.type=simple
spring.cache.cache-names=closePrices,eveningSessionPrices,lastClosePrices,lastEveningSessionPrices

# ===========================================
# STARTUP PRICE LOADING CONFIGURATION
# ===========================================
startup.price-loader.enabled=true
startup.price-loader.async-loading=true
startup.price-loader.load-close-prices=true
startup.price-loader.load-evening-session-prices=true

# ===========================================
# RETRY CONFIGURATION
# ===========================================
resilience4j.retry.instances.tinvest-api.max-attempts=3
resilience4j.retry.instances.tinvest-api.wait-duration=1s
resilience4j.retry.instances.tinvest-api.retry-exceptions=java.net.ConnectException,java.net.SocketTimeoutException,java.util.concurrent.TimeoutException

# ===========================================
# TIMELIMITER CONFIGURATION
# ===========================================
resilience4j.timelimiter.instances.tinvest-api.timeout-duration=10s
resilience4j.timelimiter.instances.tinvest-api.cancel-running-future=true

# ===========================================
# QUOTE SCANNER CONFIGURATION
# ===========================================
quote-scanner.max-quotes-per-second=10000
quote-scanner.enable-database-saving=false
quote-scanner.enable-websocket-broadcast=true
quote-scanner.enable-order-book-subscription=true
quote-scanner.order-book-depth=1
quote-scanner.enable-immediate-order-book-updates=true
quote-scanner.max-order-book-updates-per-second=0
quote-scanner.enable-test-mode=true
quote-scanner.enable-shares-mode=true

# ===========================================
# JPA SETTINGS
# ===========================================
# Отключаем автоматическое создание схемы - используем готовую схему БД
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=false
logging.level.org.hibernate=WARN

# ===========================================
# INSTRUMENT PAIRS CONFIGURATION
# ===========================================
instrument-pairs.pairs[0].pair-id=1
instrument-pairs.pairs[0].first-instrument=BBG004730N88
instrument-pairs.pairs[0].second-instrument=BBG0047315Y7
instrument-pairs.pairs[0].first-instrument-name=SBER
instrument-pairs.pairs[0].second-instrument-name=SBERP

instrument-pairs.pairs[1].pair-id=2
instrument-pairs.pairs[1].first-instrument=BBG000MZL0Y6
instrument-pairs.pairs[1].second-instrument=BBG000MZL2S9
instrument-pairs.pairs[1].first-instrument-name=PMSB
instrument-pairs.pairs[1].second-instrument-name=PMSBP

instrument-pairs.pairs[2].pair-id=3
instrument-pairs.pairs[2].first-instrument=BBG004S68598
instrument-pairs.pairs[2].second-instrument=BBG004S68FR6
instrument-pairs.pairs[2].first-instrument-name=MTLR
instrument-pairs.pairs[2].second-instrument-name=MTLRP

instrument-pairs.pairs[3].pair-id=4
instrument-pairs.pairs[3].first-instrument=BBG004RVFFC0
instrument-pairs.pairs[3].second-instrument=BBG004S68829
instrument-pairs.pairs[3].first-instrument-name=TATN
instrument-pairs.pairs[3].second-instrument-name=TATNP

instrument-pairs.pairs[4].pair-id=5
instrument-pairs.pairs[4].first-instrument=BBG004S682Z6
instrument-pairs.pairs[4].second-instrument=BBG004S685M3
instrument-pairs.pairs[4].first-instrument-name=RTKM
instrument-pairs.pairs[4].second-instrument-name=RTKMP

instrument-pairs.pairs[5].pair-id=6
instrument-pairs.pairs[5].first-instrument=FUTSBRF09250
instrument-pairs.pairs[5].second-instrument=FUTSBPR09250
instrument-pairs.pairs[5].first-instrument-name=SRU5
instrument-pairs.pairs[5].second-instrument-name=SPU5

instrument-pairs.pairs[6].pair-id=7
instrument-pairs.pairs[6].first-instrument=FUTTATN09250
instrument-pairs.pairs[6].second-instrument=FUTTATP09250
instrument-pairs.pairs[6].first-instrument-name=TTU5
instrument-pairs.pairs[6].second-instrument-name=TPU5