# Сканер фьючерсов - Детальная документация

## Обзор

Сканер фьючерсов — это веб-интерфейс для сравнения акций с ближними и дальними фьючерсами в реальном времени. Сканер позволяет анализировать спреды между акциями и фьючерсами, а также между фьючерсами разных кварталов экспирации.

### Основные возможности

- ✅ **Сравнение акций с фьючерсами** — анализ спредов между акциями и ближними/дальними фьючерсами
- ✅ **Сравнение фьючерсов** — анализ контанго/бэквордации между ближними и дальними фьючерсами
- ✅ **Реальное время** — обновление данных через WebSocket
- ✅ **Предзагрузка пар** — автоматическая загрузка всех пар при открытии страницы
- ✅ **Настройка отображения** — сортировка, фильтрация и ограничение количества результатов
- ✅ **Управление индексами** — добавление и удаление индексов для отслеживания
- ✅ **Статистика** — отображение активных инструментов, объемов торгов и скорости обновления

## Архитектура

### Компоненты

1. **Frontend (JavaScript)**
   - `futures-scanner.js` — основная логика сканера
   - `indices-bar.js` — управление строкой индексов
   - `futures-scanner.html` — интерфейс пользователя

2. **Backend (Java)**
   - `FuturesScannerController` — REST API для управления сканером
   - `FutureService` — работа с данными фьючерсов из БД
   - `QuoteScannerService` — координация обработки данных
   - `PriceCacheService` — кэш цен для быстрого доступа

3. **База данных**
   - `invest_ref.futures` — справочник фьючерсов с данными об экспирации и базовых активах

### Поток данных

```
1. Загрузка страницы
   │
   ├─► Загрузка данных о фьючерсах (/api/scanner/futures)
   ├─► Загрузка текущих цен (/api/scanner/current-prices)
   ├─► Предзагрузка всех пар (loadAllPairsOnPageLoad)
   │
   ▼
2. WebSocket подключение
   │
   ├─► Подписка на котировки (ws://localhost:PORT/ws/quotes)
   ├─► Получение обновлений в реальном времени
   │
   ▼
3. Обновление пар
   │
   ├─► Группировка по базовому активу
   ├─► Определение ближних и дальних фьючерсов
   ├─► Расчет спредов
   ├─► Сортировка и фильтрация
   └─► Отображение в таблицах
```

## API Endpoints

### Получение данных о фьючерсах

**GET** `/api/scanner/futures`

Возвращает список всех фьючерсов с данными об экспирации.

**Ответ:**
```json
{
  "futures": [
    {
      "figi": "FUTSBER-12.25",
      "ticker": "SRZ5",
      "basicAsset": "SBER",
      "basicAssetSize": 100,
      "expirationDate": "2025-12-15T18:45:00",
      "assetType": "TYPE_SECURITY",
      "exchange": "MOEX"
    }
  ],
  "count": 150
}
```

### Получение текущих цен

**GET** `/api/scanner/current-prices`

Возвращает текущие цены всех инструментов.

**Ответ:**
```json
{
  "prices": {
    "BBG004730N88": 250.5,
    "FUTSBER-12.25": 25100.0
  },
  "instrumentNames": {
    "BBG004730N88": "SBER",
    "FUTSBER-12.25": "SRZ5"
  },
  "count": 200
}
```

### Управление индексами

**GET** `/api/scanner/futures-scanner/indices`

Получить список индексов для сканера фьючерсов.

**POST** `/api/scanner/futures-scanner/indices/add`

Добавить новый индекс.

**DELETE** `/api/scanner/futures-scanner/indices/remove`

Удалить индекс.

**GET** `/api/scanner/futures-scanner/indices/prices`

Получить цены закрытия для индексов.

### Статус сканера

**GET** `/api/scanner/futures-scanner/status`

Получить статус сканера фьючерсов.

**Ответ:**
```json
{
  "active": true,
  "testMode": false,
  "message": "Сканер фьючерсов активен"
}
```

## Формирование пар

### Принцип работы

Сканер фьючерсов формирует пары для сравнения на основе следующих принципов:

#### 1. Группировка по базовому активу

Все инструменты группируются по **базовому активу (basicAsset)**:

- **Для фьючерсов**: используется поле `basicAsset` из таблицы `invest_ref.futures`
- **Для акций**: используется тикер акции напрямую

**Примеры:**
- Фьючерс `SRZ5` (SBER) имеет `basicAsset = "SBER"`
- Акция `SBER` имеет тикер `SBER`
- Оба инструмента группируются под базовым активом `SBER`

#### 2. Определение базового тикера

Базовый тикер определяется функцией `getBaseTicker()`:

```javascript
// Для фьючерсов из кэша используется basicAsset
if (futuresDataCache.has(figi)) {
    return futuresData.basicAsset.toUpperCase();
}

// Для фьючерсов по тикеру убираются суффиксы:
// - Z5, H6 (специальные суффиксы)
// - F, G, H, J, K, M, N, Q, U, V, X, Z (месяцы экспирации)

// Для акций возвращается тикер как есть
return ticker.toUpperCase();
```

**Примеры:**
- `SRZ5` → `SBER` (убирается суффикс Z5)
- `GAZH6` → `GAZP` (убирается суффикс H6)
- `SBER` → `SBER` (акция остается без изменений)

#### 3. Определение ближнего и дальнего фьючерсов

Ближний и дальний фьючерсы определяются на основе **квартала экспирации**:

##### Ближний фьючерс (Near Futures)
- Фьючерс с **ближайшей датой экспирации** среди всех фьючерсов базового актива
- Определяется сортировкой всех фьючерсов по дате экспирации и выбором первого

##### Дальний фьючерс (Far Futures)
- Фьючерс, экспирация которого приходится на **следующий квартал** после ближнего
- Если ближний фьючерс — Q4, то дальний — Q1 следующего года

**Алгоритм:**
```javascript
// 1. Собираем все фьючерсы для базового актива
// 2. Определяем квартал экспирации для каждого фьючерса
// 3. Сортируем по дате экспирации
// 4. Ближний = первый (ближайший)
// 5. Дальний = следующий квартал после ближнего
```

**Примеры:**
- Ближний: `SRZ5` (экспирация Q4 2025)
- Дальний: `SRH6` (экспирация Q1 2026)

#### 4. Типы формируемых пар

Формируются **три типа пар** для каждого базового актива:

##### 4.1. Акция vs Ближний фьючерс (Stock vs Near Futures)
- **Условие**: должна существовать акция и ближний фьючерс
- **Использование**: сравнение текущей цены акции с ценой ближайшего фьючерса
- **Отображается в**: таблице "Акции vs Ближние фьючерсы"

##### 4.2. Акция vs Дальний фьючерс (Stock vs Far Futures)
- **Условие**: должна существовать акция и дальний фьючерс
- **Использование**: сравнение текущей цены акции с ценой фьючерса следующего квартала
- **Отображается в**: таблице "Акции vs Дальние фьючерсы"

##### 4.3. Ближний vs Дальний фьючерс (Near vs Far Futures)
- **Условие**: должны существовать оба фьючерса (ближний и дальний)
- **Использование**: сравнение цен фьючерсов разных кварталов (контанго/бэквордация)
- **Отображается в**: таблице "Ближние vs Дальние фьючерсы"

#### 5. Расчет спреда

Спред рассчитывается для каждой пары:

```javascript
// Спред % = ((фьючерс / (акция * лотность)) - 1) * 100
const spreadPercent = stockPrice > 0 && lotSize > 0 ?
    ((futuresPrice / (stockPrice * lotSize)) - 1) * 100 : 0;
```

Где:
- `futuresPrice` — цена фьючерса
- `stockPrice` — цена акции
- `lotSize` — лотность базового актива (`basicAssetSize` из таблицы `futures`)

**Интерпретация спреда:**
- **Положительный спред** — фьючерс дороже акции (контанго)
- **Отрицательный спред** — фьючерс дешевле акции (бэквордация)

#### 6. Примеры формирования пар

**Пример 1: SBER**
- Базовый актив: `SBER`
- Акция: `SBER` (FIGI: `BBG004730N88`)
- Ближний фьючерс: `SRZ5` (экспирация Q4 2025)
- Дальний фьючерс: `SRH6` (экспирация Q1 2026)

**Формируемые пары:**
1. `SBER` vs `SRZ5` (акция vs ближний фьючерс)
2. `SBER` vs `SRH6` (акция vs дальний фьючерс)
3. `SRZ5` vs `SRH6` (ближний vs дальний фьючерс)

**Пример 2: GAZP**
- Базовый актив: `GAZP`
- Акция: `GAZP` (FIGI: `BBG004730RP0`)
- Ближний фьючерс: `GZZ5` (экспирация Q4 2025)
- Дальний фьючерс: `GZH6` (экспирация Q1 2026)

**Формируемые пары:**
1. `GAZP` vs `GZZ5` (акция vs ближний фьючерс)
2. `GAZP` vs `GZH6` (акция vs дальний фьючерс)
3. `GZZ5` vs `GZH6` (ближний vs дальний фьючерс)

## Особенности реализации

### Кэширование данных фьючерсов

- Данные о фьючерсах загружаются один раз при инициализации через `/api/scanner/futures`
- Кэш содержит: `figi`, `ticker`, `expirationDate`, `basicAsset`, `basicAssetSize`
- Кэш обновляется только при перезагрузке страницы

### Определение квартала экспирации

```javascript
// Квартал определяется по месяцу экспирации:
// Q1: январь-март (месяцы 1-3)
// Q2: апрель-июнь (месяцы 4-6)
// Q3: июль-сентябрь (месяцы 7-9)
// Q4: октябрь-декабрь (месяцы 10-12)
```

### Предзагрузка пар

При загрузке страницы автоматически выполняется:

1. Загрузка данных о фьючерсах из `/api/scanner/futures`
2. Загрузка текущих цен из `/api/scanner/current-prices`
3. Создание объектов quote для всех инструментов
4. Добавление всех фьючерсов из кэша (даже без цен)
5. Формирование и отображение всех пар

Это позволяет видеть все пары сразу после загрузки страницы, не дожидаясь подключения к WebSocket.

### Обновление в реальном времени

После подключения к WebSocket:

- Получение обновлений котировок в реальном времени
- Автоматическое обновление цен в объектах quote
- Пересчет спредов при изменении цен
- Обновление таблиц с парами

### Фильтрация результатов

- Пары сортируются по настраиваемым параметрам (спред, объем, экспирация)
- Отображается топ-N пар согласно настройкам пользователя
- Настройки применяются отдельно для каждой таблицы

## Настройки отображения

Пользователь может настроить для каждой таблицы:

### Параметры сортировки

- **Сортировать по**: спред (фьючерс - акция), спред %, объем акции, объем фьючерса, экспирация
- **Порядок**: наибольший спред, наименьший спред
- **Показать**: топ-5, топ-10, топ-15, все

### Применение настроек

Настройки применяются немедленно при изменении и сохраняются в памяти браузера на время сессии.

## Интерфейс пользователя

### Статистика

В верхней части страницы отображается:

- **Активных инструментов** — количество инструментов с активными котировками
- **Объем торгов** — суммарный объем торгов по всем инструментам
- **Скорость обновления** — количество обновлений в секунду
- **Последнее обновление** — время последнего обновления данных
- **Режим сканера** — статус сканера (Активен / Тестовый режим)

### Таблицы

Три основные таблицы:

1. **Акции vs Ближние фьючерсы** — сравнение акций с ближайшими фьючерсами
2. **Акции vs Дальние фьючерсы** — сравнение акций с фьючерсами следующего квартала
3. **Ближние vs Дальние фьючерсы** — сравнение фьючерсов разных кварталов

### Управление

- **Подключиться** — подключение к WebSocket для получения данных в реальном времени
- **Отключиться** — отключение от WebSocket
- **Управление индексами** — добавление и удаление индексов для отслеживания
- **← На главную** — возврат на главную страницу

## Структура данных

### Объект Quote

```javascript
{
    figi: "BBG004730N88",
    ticker: "SBER",
    currentPrice: 250.5,
    volume: 1000,
    timestamp: "2025-01-09T15:30:00.000Z"
}
```

### Объект FuturesData

```javascript
{
    figi: "FUTSBER-12.25",
    ticker: "SRZ5",
    expirationDate: "2025-12-15T18:45:00",
    basicAsset: "SBER",
    assetType: "TYPE_SECURITY",
    basicAssetSize: 100
}
```

### Объект Comparison

```javascript
{
    baseTicker: "SBER",
    stock: Quote,
    futures: Quote,
    lotSize: 100,
    stockPrice: 250.5,
    futuresPrice: 25100.0,
    spreadPercent: 0.2,
    expirationDays: 40,
    stockVolume: 1000,
    futuresVolume: 500
}
```

## Обработка ошибок

### Типичные ошибки

1. **Ошибка загрузки данных о фьючерсах**
   - Логируется в консоль
   - Сканер продолжает работу с доступными данными

2. **Ошибка загрузки цен**
   - Логируется в консоль
   - Используются цены из WebSocket при подключении

3. **Ошибка WebSocket подключения**
   - Автоматическая попытка переподключения
   - Отображение статуса подключения

4. **Отсутствие данных для пары**
   - Пара не отображается в таблице
   - Логируется предупреждение в консоль

## Производительность

### Оптимизации

1. **Кэширование данных** — данные о фьючерсах загружаются один раз
2. **Предзагрузка пар** — все пары загружаются при открытии страницы
3. **Дебаунсинг обновлений** — обновления таблиц группируются
4. **Ленивая загрузка** — загрузка цен закрытия только при необходимости

### Метрики

- **Время загрузки страницы** — зависит от количества инструментов
- **Частота обновлений** — до 25 обновлений в секунду
- **Использование памяти** — зависит от количества отслеживаемых инструментов

## Использование

### Открытие сканера

Перейдите по адресу:
```
http://localhost:8088/pages/futures-scanner.html
```

### Подключение к данным

1. Нажмите кнопку **"Подключиться"**
2. Дождитесь статуса **"Подключено"**
3. Данные начнут обновляться в реальном времени

### Настройка отображения

1. Выберите параметры сортировки для нужной таблицы
2. Выберите порядок сортировки
3. Выберите количество отображаемых пар
4. Настройки применяются автоматически

### Управление индексами

1. Нажмите кнопку **"Управление индексами"**
2. Добавьте или удалите индексы
3. Индексы отображаются в верхней части страницы

## Резюме

Сканер фьючерсов обеспечивает:

1. **Автоматическое формирование пар** на основе базовых активов
2. **Определение ближних и дальних фьючерсов** по кварталу экспирации
3. **Создание трех типов пар** для каждого базового актива
4. **Расчет спредов** с учетом лотности базового актива
5. **Предзагрузку всех пар** при открытии страницы
6. **Обновление в реальном времени** через WebSocket
7. **Гибкие настройки отображения** для каждой таблицы

Сканер работает в любое время (включая выходные дни до 8:30) и может быть включен в тестовом режиме для работы вне торговых сессий.

## Связанная документация

- [QuoteScannerService](./QUOTE_SCANNER_SERVICE.md) — центральный сервис сканирования котировок
- [API Documentation](./API.md) — полная документация REST API
- [GRPC Limits](./GRPC_LIMITS.md) — лимиты gRPC подписок

