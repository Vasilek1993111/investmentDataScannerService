# Сканер фьючерсов - Детальная документация

## Обзор

Сканер фьючерсов — это веб-интерфейс для сравнения акций с ближними и дальними фьючерсами в реальном времени. Сканер позволяет анализировать спреды между акциями и фьючерсами, а также между фьючерсами разных кварталов экспирации.

### Основные возможности

- ✅ **Сравнение акций с фьючерсами** — анализ спредов между акциями и ближними/дальними фьючерсами
- ✅ **Сравнение фьючерсов** — анализ контанго/бэквордации между ближними и дальними фьючерсами
- ✅ **Реальное время** — обновление данных через WebSocket
- ✅ **Предзагрузка пар** — автоматическая загрузка всех пар при открытии страницы
- ✅ **Настройка отображения** — сортировка, фильтрация и ограничение количества результатов
- ✅ **Управление индексами** — добавление и удаление индексов для отслеживания
- ✅ **Статистика** — отображение активных инструментов, объемов торгов и скорости обновления
- ✅ **BID/ASK данные** — отображение лучших цен покупки и продажи с объемами
- ✅ **Дельта** — расчет отклонения спреда от справедливого расхождения
- ✅ **Справедливое расхождение** — расчет на основе ключевой ставки и дней до экспирации
- ✅ **Выделение текста** — возможность выделения и копирования данных из таблиц

## Архитектура

### Компоненты

1. **Frontend (JavaScript)**
   - `futures-scanner.js` — основная логика сканера
   - `indices-bar.js` — управление строкой индексов
   - `futures-scanner.html` — интерфейс пользователя

2. **Backend (Java)**
   - `FuturesScannerController` — REST API для управления сканером
   - `FutureService` — работа с данными фьючерсов из БД
   - `QuoteScannerService` — координация обработки данных
   - `PriceCacheService` — кэш цен для быстрого доступа

3. **База данных**
   - `invest_ref.futures` — справочник фьючерсов с данными об экспирации и базовых активах

### Поток данных

```
1. Загрузка страницы
   │
   ├─► Загрузка данных о фьючерсах (/api/scanner/futures)
   ├─► Загрузка текущих цен (/api/scanner/current-prices)
   ├─► Предзагрузка всех пар (loadAllPairsOnPageLoad)
   │
   ▼
2. WebSocket подключение
   │
   ├─► Подписка на котировки (ws://localhost:PORT/ws/quotes)
   ├─► Получение обновлений в реальном времени
   │
   ▼
3. Обновление пар
   │
   ├─► Группировка по базовому активу
   ├─► Определение ближних и дальних фьючерсов
   ├─► Расчет спредов
   ├─► Сортировка и фильтрация
   └─► Отображение в таблицах
```

## API Endpoints

### Получение данных о фьючерсах

**GET** `/api/scanner/futures`

Возвращает список всех фьючерсов с данными об экспирации.

**Ответ:**
```json
{
  "futures": [
    {
      "figi": "FUTSBER-12.25",
      "ticker": "SRZ5",
      "basicAsset": "SBER",
      "basicAssetSize": 100,
      "expirationDate": "2025-12-15T18:45:00",
      "assetType": "TYPE_SECURITY",
      "exchange": "MOEX"
    }
  ],
  "count": 150
}
```

### Получение текущих цен

**GET** `/api/scanner/current-prices`

Возвращает текущие цены всех инструментов.

**Ответ:**
```json
{
  "prices": {
    "BBG004730N88": 250.5,
    "FUTSBER-12.25": 25100.0
  },
  "instrumentNames": {
    "BBG004730N88": "SBER",
    "FUTSBER-12.25": "SRZ5"
  },
  "count": 200
}
```

### Управление индексами

**GET** `/api/scanner/futures-scanner/indices`

Получить список индексов для сканера фьючерсов.

**POST** `/api/scanner/futures-scanner/indices/add`

Добавить новый индекс.

**DELETE** `/api/scanner/futures-scanner/indices/remove`

Удалить индекс.

**GET** `/api/scanner/futures-scanner/indices/prices`

Получить цены закрытия для индексов.

### Статус сканера

**GET** `/api/scanner/futures-scanner/status`

Получить статус сканера фьючерсов.

**Ответ:**
```json
{
  "active": true,
  "testMode": false,
  "keyRate": 16.5,
  "message": "Сканер фьючерсов активен"
}
```

### Получение ключевой ставки

**GET** `/api/scanner/futures/key-rate`

Получить текущую ключевую ставку для расчета справедливого расхождения.

**Ответ:**
```json
{
  "keyRate": 16.5
}
```

## Формирование пар

### Принцип работы

Сканер фьючерсов формирует пары для сравнения на основе следующих принципов:

#### 1. Группировка по базовому активу

Все инструменты группируются по **базовому активу (basicAsset)**:

- **Для фьючерсов**: используется поле `basicAsset` из таблицы `invest_ref.futures`
- **Для акций**: используется тикер акции напрямую

**Примеры:**
- Фьючерс `SRZ5` (SBER) имеет `basicAsset = "SBER"`
- Акция `SBER` имеет тикер `SBER`
- Оба инструмента группируются под базовым активом `SBER`

#### 2. Определение базового тикера

Базовый тикер определяется функцией `getBaseTicker()`:

```javascript
// Для фьючерсов из кэша используется basicAsset
if (futuresDataCache.has(figi)) {
    return futuresData.basicAsset.toUpperCase();
}

// Для фьючерсов по тикеру убираются суффиксы:
// - Z5, H6 (специальные суффиксы)
// - F, G, H, J, K, M, N, Q, U, V, X, Z (месяцы экспирации)

// Для акций возвращается тикер как есть
return ticker.toUpperCase();
```

**Примеры:**
- `SRZ5` → `SBER` (убирается суффикс Z5)
- `GAZH6` → `GAZP` (убирается суффикс H6)
- `SBER` → `SBER` (акция остается без изменений)

#### 3. Определение ближнего и дальнего фьючерсов

Ближний и дальний фьючерсы определяются на основе **квартала экспирации**:

##### Ближний фьючерс (Near Futures)
- Фьючерс с **ближайшей датой экспирации** среди всех фьючерсов базового актива
- Определяется сортировкой всех фьючерсов по дате экспирации и выбором первого

##### Дальний фьючерс (Far Futures)
- Фьючерс, экспирация которого приходится на **следующий квартал** после ближнего
- Если ближний фьючерс — Q4, то дальний — Q1 следующего года

**Алгоритм:**
```javascript
// 1. Собираем все фьючерсы для базового актива
// 2. Определяем квартал экспирации для каждого фьючерса
// 3. Сортируем по дате экспирации
// 4. Ближний = первый (ближайший)
// 5. Дальний = следующий квартал после ближнего
```

**Примеры:**
- Ближний: `SRZ5` (экспирация Q4 2025)
- Дальний: `SRH6` (экспирация Q1 2026)

#### 4. Типы формируемых пар

Формируются **три типа пар** для каждого базового актива:

##### 4.1. Акция vs Ближний фьючерс (Stock vs Near Futures)
- **Условие**: должна существовать акция и ближний фьючерс
- **Использование**: сравнение текущей цены акции с ценой ближайшего фьючерса
- **Отображается в**: таблице "Акции vs Ближние фьючерсы"

##### 4.2. Акция vs Дальний фьючерс (Stock vs Far Futures)
- **Условие**: должна существовать акция и дальний фьючерс
- **Использование**: сравнение текущей цены акции с ценой фьючерса следующего квартала
- **Отображается в**: таблице "Акции vs Дальние фьючерсы"

##### 4.3. Ближний vs Дальний фьючерс (Near vs Far Futures)
- **Условие**: должны существовать оба фьючерса (ближний и дальний)
- **Использование**: сравнение цен фьючерсов разных кварталов (контанго/бэквордация)
- **Отображается в**: таблице "Ближние vs Дальние фьючерсы"

#### 5. Получение последней цены фьючерса

Последняя цена фьючерса (`currentPrice`) получается из нескольких источников:

##### 5.1. При загрузке страницы

При инициализации сканера цены загружаются через REST API:

**GET** `/api/scanner/current-prices`

**Источник данных:**
- Цены берутся из **in-memory кэша** `InstrumentCacheService.lastPrices`
- Кэш заполняется из базы данных: таблица `invest_prices.last_prices`
- В таблице хранятся последние цены сделок по каждому инструменту (FIGI)
- При старте приложения кэш загружается из БД (последние цены за сегодня или последнюю торговую дату)

**Структура ответа:**
```json
{
  "prices": {
    "FUTSBER-12.25": 25100.0,
    "FUTGAZP-12.25": 180.5
  },
  "instrumentNames": {
    "FUTSBER-12.25": "SRZ5",
    "FUTGAZP-12.25": "GZZ5"
  },
  "count": 150
}
```

##### 5.2. При обновлении через WebSocket

После подключения к WebSocket цены обновляются в реальном времени:

**Источник данных:**
- **LastPrice события** от Tinkoff Invest API — последняя цена сделки по инструменту
- **Trade события** от Tinkoff Invest API — цены из реальных сделок

**Обработка:**
1. События обрабатываются в `MarketDataProcessor.processLastPrice()` или `processTrade()`
2. Цена конвертируется из формата Tinkoff API (Quotation) в `BigDecimal`
3. Цена сохраняется в кэш `InstrumentCacheService.setLastPrice(figi, price)`
4. Создается объект `QuoteData` через `QuoteDataFactory.createFromLastPrice()` или `createFromTrade()`
5. Данные отправляются через WebSocket всем подписчикам

**Формат данных в WebSocket:**
```json
{
  "figi": "FUTSBER-12.25",
  "ticker": "SRZ5",
  "currentPrice": 25100.0,
  "timestamp": "2025-01-09T15:30:00.000Z",
  "bestBid": 25095.0,
  "bestAsk": 25105.0,
  "bestBidQuantity": 10,
  "bestAskQuantity": 5
}
```

##### 5.3. Хранение в базе данных

Цены хранятся в таблице `invest_prices.last_prices`:

**Структура таблицы:**
- `figi` — идентификатор инструмента
- `time` — время последней сделки
- `price` — цена последней сделки
- `date` — дата сделки

**Загрузка в кэш:**
- При старте приложения: `PriceCacheService.loadAllLastPrices()`
- Загружаются последние цены за сегодня или последнюю торговую дату
- Кэш обновляется при получении новых данных через WebSocket

##### 5.4. Обновление цены в сканере

В JavaScript коде (`futures-scanner.js`):

```javascript
// При загрузке страницы
const pricesData = await fetch('/api/scanner/current-prices');
const prices = pricesData.prices || {};
quoteData.currentPrice = prices[figi] || 0;

// При получении данных через WebSocket
function updateQuote(quoteData) {
    // currentPrice уже содержится в quoteData от сервера
    quotes.set(figi, quoteData);
    updateFuturesComparisons();
}
```

**Особенности:**
- Если цена отсутствует при загрузке, устанавливается `0` (будет обновлено через WebSocket)
- При обновлении через WebSocket цена заменяется новой
- Если новое значение `null` или `undefined`, сохраняется предыдущее значение (для частичных обновлений)

#### 6. Расчет спреда

Спред рассчитывается для каждой пары:

```javascript
// Спред % = ((фьючерс / (акция * лотность)) - 1) * 100
const spreadPercent = stockPrice > 0 && lotSize > 0 ?
    ((futuresPrice / (stockPrice * lotSize)) - 1) * 100 : 0;
```

Где:
- `futuresPrice` — последняя цена фьючерса (`currentPrice` из `QuoteData`)
- `stockPrice` — последняя цена акции (`currentPrice` из `QuoteData`)
- `lotSize` — лотность базового актива (`basicAssetSize` из таблицы `futures`)

**Интерпретация спреда:**
- **Положительный спред** — фьючерс дороже акции (контанго)
- **Отрицательный спред** — фьючерс дешевле акции (бэквордация)

#### 7. Расчет справедливого расхождения

Справедливое расхождение рассчитывается на основе ключевой ставки ЦБ РФ и количества дней до экспирации:

```javascript
// Справедливое расхождение = (ключевая ставка / 365) * дни до экспирации
const fairSpread = daysToExpiration > 0 ? (keyRate / 365) * daysToExpiration : 0;
```

Где:
- `keyRate` — ключевая ставка ЦБ РФ в процентах (по умолчанию 16.5%, настраивается в конфигурации)
- `daysToExpiration` — количество дней до экспирации фьючерса

**Для пары "Ближний vs Дальний фьючерс":**
```javascript
// Справедливое расхождение = (ключевая ставка / 365) * разница в днях
const daysDifference = farDays - nearDays;
const fairSpread = daysDifference > 0 ? (keyRate / 365) * daysDifference : 0;
```

**Отображение:**
- Справедливое расхождение отображается **один раз для каждой группы** фьючерсов
- Для групп "Акции vs Ближние/Дальние фьючерсы" показывается среднее значение для всех фьючерсов в группе
- Для группы "Ближние vs Дальние фьючерсы" показывается среднее значение разницы в днях

#### 8. Расчет дельты

Дельта рассчитывается как разница между спредом и справедливым расхождением:

```javascript
// Дельта = Спред % - Справедливое расхождение
const delta = spreadPercent - fairSpread;
```

**Интерпретация дельты:**
- **Положительная дельта** — спред выше справедливого расхождения (фьючерс переоценен)
- **Отрицательная дельта** — спред ниже справедливого расхождения (фьючерс недооценен)
- **Дельта близкая к нулю** — спред соответствует справедливому расхождению

#### 9. Проверка базовых активов

Перед формированием пары "Ближний vs Дальний фьючерс" выполняется строгая проверка:

1. **Проверка `basicAsset`** — если у обоих фьючерсов есть `basicAsset`, они должны совпадать
2. **Проверка по тикеру** — если `basicAsset` отсутствует, проверяется базовый тикер из тикера
3. **Исключения** — некоторые пары явно исключаются (например, RMZ5-RIH6)

**Исключаемые пары:**
- `RMZ5` - `RIH6` (в любом порядке)

Эти пары не отображаются в таблице, даже если у них одинаковый `basicAsset` в базе данных.

#### 10. Примеры формирования пар

**Пример 1: SBER**
- Базовый актив: `SBER`
- Акция: `SBER` (FIGI: `BBG004730N88`)
- Ближний фьючерс: `SRZ5` (экспирация Q4 2025)
- Дальний фьючерс: `SRH6` (экспирация Q1 2026)

**Формируемые пары:**
1. `SBER` vs `SRZ5` (акция vs ближний фьючерс)
2. `SBER` vs `SRH6` (акция vs дальний фьючерс)
3. `SRZ5` vs `SRH6` (ближний vs дальний фьючерс)

**Пример 2: GAZP**
- Базовый актив: `GAZP`
- Акция: `GAZP` (FIGI: `BBG004730RP0`)
- Ближний фьючерс: `GZZ5` (экспирация Q4 2025)
- Дальний фьючерс: `GZH6` (экспирация Q1 2026)

**Формируемые пары:**
1. `GAZP` vs `GZZ5` (акция vs ближний фьючерс)
2. `GAZP` vs `GZH6` (акция vs дальний фьючерс)
3. `GZZ5` vs `GZH6` (ближний vs дальний фьючерс)

## Особенности реализации

### Кэширование данных фьючерсов

- Данные о фьючерсах загружаются один раз при инициализации через `/api/scanner/futures`
- Кэш содержит: `figi`, `ticker`, `expirationDate`, `basicAsset`, `basicAssetSize`
- Кэш обновляется только при перезагрузке страницы

### Определение квартала экспирации

```javascript
// Квартал определяется по месяцу экспирации:
// Q1: январь-март (месяцы 1-3)
// Q2: апрель-июнь (месяцы 4-6)
// Q3: июль-сентябрь (месяцы 7-9)
// Q4: октябрь-декабрь (месяцы 10-12)
```

### Предзагрузка пар

При загрузке страницы автоматически выполняется:

1. Загрузка данных о фьючерсах из `/api/scanner/futures`
2. Загрузка текущих цен из `/api/scanner/current-prices`
3. Создание объектов quote для всех инструментов
4. Добавление всех фьючерсов из кэша (даже без цен)
5. Формирование и отображение всех пар

Это позволяет видеть все пары сразу после загрузки страницы, не дожидаясь подключения к WebSocket.

### Обновление в реальном времени

После подключения к WebSocket:

- Получение обновлений котировок в реальном времени
- Автоматическое обновление цен в объектах quote
- **Независимая загрузка BID/ASK данных** — данные стакана обновляются независимо от `last_price`
- Пересчет спредов при изменении цен
- Обновление таблиц с парами **напрямую** (без дебаунсинга) для максимальной отзывчивости

**Особенности обновления:**
- BID/ASK данные загружаются и обновляются независимо от наличия `last_price`
- Таблицы обновляются немедленно при получении данных (логика как в сканере выходного дня)
- Обновление происходит напрямую, без задержек и дебаунсинга

### Фильтрация результатов

- Пары сортируются по настраиваемым параметрам (спред, объем, экспирация)
- Отображается топ-N пар согласно настройкам пользователя
- Настройки применяются отдельно для каждой таблицы

## Настройки отображения

Пользователь может настроить для каждой таблицы:

### Параметры сортировки

- **Сортировать по**: спред (фьючерс - акция), спред %, объем акции, объем фьючерса, экспирация
- **Порядок**: наибольший спред, наименьший спред
- **Показать**: топ-5, топ-10, топ-15, все

### Применение настроек

Настройки применяются немедленно при изменении и сохраняются в памяти браузера на время сессии.

## Интерфейс пользователя

### Статистика

В верхней части страницы отображается:

- **Активных инструментов** — количество инструментов с активными котировками
- **Объем торгов** — суммарный объем торгов по всем инструментам
- **Скорость обновления** — количество обновлений в секунду
- **Последнее обновление** — время последнего обновления данных
- **Режим сканера** — статус сканера (Активен / Тестовый режим)

### Таблицы

Три основные таблицы:

1. **Акции vs Ближние фьючерсы** — сравнение акций с ближайшими фьючерсами
2. **Акции vs Дальние фьючерсы** — сравнение акций с фьючерсами следующего квартала
3. **Ближние vs Дальние фьючерсы** — сравнение фьючерсов разных кварталов

#### Столбцы таблиц

**Таблицы "Акции vs Ближние/Дальние фьючерсы":**
- Акция — тикер акции
- Фьючерс — тикер фьючерса
- Лотность — лотность базового актива
- Последняя цена акции — текущая цена акции
- Последняя цена фьючерса — текущая цена фьючерса
- Объем акции — объем торгов акцией
- Объем фьючерса — объем торгов фьючерсом
- **BID** — лучшая цена покупки фьючерса с объемом (например, "400.05 (10)")
- **ASK** — лучшая цена продажи фьючерса с объемом (например, "400.10 (5)")
- Спред % — процентный спред между фьючерсом и акцией
- **Дельта** — разница между спредом и справедливым расхождением
- Время — время последнего обновления

**Таблица "Ближние vs Дальние фьючерсы":**
- Ближний — тикер ближнего фьючерса
- Дальний — тикер дальнего фьючерса
- Лотность — лотность базового актива
- Цена ближнего — текущая цена ближнего фьючерса
- Цена дальнего — текущая цена дальнего фьючерса
- Объем ближнего — объем торгов ближним фьючерсом
- Объем дальнего — объем торгов дальним фьючерсом
- **BID (ближний)** — лучшая цена покупки ближнего фьючерса с объемом
- **ASK (ближний)** — лучшая цена продажи ближнего фьючерса с объемом
- **BID (дальний)** — лучшая цена покупки дальнего фьючерса с объемом
- **ASK (дальний)** — лучшая цена продажи дальнего фьючерса с объемом
- Спред % — процентный спред между дальним и ближним фьючерсами
- **Дельта** — разница между спредом и справедливым расхождением
- Время — время последнего обновления

#### Информация о группе

Над каждой таблицей отображается информация о группе:

- **Справедливое расхождение (среднее)** — среднее значение справедливого расхождения для всех фьючерсов в группе
- **Экспирация** — информация о днях до экспирации:
  - Для групп "Акции vs Ближние/Дальние фьючерсы": диапазон и среднее значение дней (например, "30-45 дн. (среднее: 38 дн.)")
  - Для группы "Ближние vs Дальние фьючерсы": среднее значение для ближнего и дальнего фьючерсов (например, "ближний 40 дн., дальний 131 дн.")

### Управление

- **Подключиться** — подключение к WebSocket для получения данных в реальном времени
- **Отключиться** — отключение от WebSocket
- **Управление индексами** — добавление и удаление индексов для отслеживания
- **← На главную** — возврат на главную страницу

### Выделение и копирование данных

- **Выделение текста** — все данные в таблицах можно выделять и копировать стандартным способом (Ctrl+C или через контекстное меню)
- **Тикеры** — тикеры акций и фьючерсов можно легко выделить и скопировать
- **Числовые данные** — все цены, объемы и проценты можно копировать для дальнейшего анализа

## Структура данных

### Объект Quote

```javascript
{
    figi: "BBG004730N88",
    ticker: "SBER",
    currentPrice: 250.5,
    volume: 1000,
    timestamp: "2025-01-09T15:30:00.000Z",
    bestBid: 250.45,        // Лучшая цена покупки
    bestBidQuantity: 100,   // Объем по лучшей цене покупки
    bestAsk: 250.55,        // Лучшая цена продажи
    bestAskQuantity: 50     // Объем по лучшей цене продажи
}
```

### Объект FuturesData

```javascript
{
    figi: "FUTSBER-12.25",
    ticker: "SRZ5",
    expirationDate: "2025-12-15T18:45:00",
    basicAsset: "SBER",
    assetType: "TYPE_SECURITY",
    basicAssetSize: 100
}
```

### Объект Comparison

```javascript
{
    baseTicker: "SBER",
    stock: Quote,
    futures: Quote,
    lotSize: 100,
    stockPrice: 250.5,
    futuresPrice: 25100.0,
    spreadPercent: 0.2,
    fairSpread: 1.81,        // Справедливое расхождение (ключевая ставка / 365 * дни)
    delta: -1.61,            // Дельта (спред - справедливое расхождение)
    expirationDays: 40,
    stockVolume: 1000,
    futuresVolume: 500,
    futuresBid: 25095.0,     // BID фьючерса
    futuresBidQuantity: 10,  // Объем по BID фьючерса
    futuresAsk: 25105.0,     // ASK фьючерса
    futuresAskQuantity: 5    // Объем по ASK фьючерса
}
```

## Обработка ошибок

### Типичные ошибки

1. **Ошибка загрузки данных о фьючерсах**
   - Логируется в консоль
   - Сканер продолжает работу с доступными данными

2. **Ошибка загрузки цен**
   - Логируется в консоль
   - Используются цены из WebSocket при подключении

3. **Ошибка WebSocket подключения**
   - Автоматическая попытка переподключения
   - Отображение статуса подключения

4. **Отсутствие данных для пары**
   - Пара не отображается в таблице
   - Логируется предупреждение в консоль

## Производительность

### Оптимизации

1. **Кэширование данных** — данные о фьючерсах загружаются один раз
2. **Предзагрузка пар** — все пары загружаются при открытии страницы
3. **Прямое обновление таблиц** — таблицы обновляются напрямую при получении данных (без дебаунсинга) для максимальной отзывчивости
4. **Ленивая загрузка** — загрузка цен закрытия только при необходимости
5. **Независимая загрузка BID/ASK** — данные стакана загружаются и обновляются независимо от `last_price`
6. **Кэширование результатов** — кэширование результатов `findNearAndFarFutures` для оптимизации (отключено для актуальности данных)
7. **Асинхронная загрузка цен** — загрузка цен закрытия выполняется асинхронно, не блокируя основной поток

### Метрики

- **Время загрузки страницы** — зависит от количества инструментов
- **Частота обновлений** — до 25 обновлений в секунду
- **Использование памяти** — зависит от количества отслеживаемых инструментов

## Использование

### Открытие сканера

Перейдите по адресу:
```
http://localhost:8088/pages/futures-scanner.html
```

### Подключение к данным

1. Нажмите кнопку **"Подключиться"**
2. Дождитесь статуса **"Подключено"**
3. Данные начнут обновляться в реальном времени

### Настройка отображения

1. Выберите параметры сортировки для нужной таблицы
2. Выберите порядок сортировки
3. Выберите количество отображаемых пар
4. Настройки применяются автоматически

### Управление индексами

1. Нажмите кнопку **"Управление индексами"**
2. Добавьте или удалите индексы
3. Индексы отображаются в верхней части страницы

## Конфигурация

### Ключевая ставка

Ключевая ставка ЦБ РФ используется для расчета справедливого расхождения. Настраивается в конфигурации:

```properties
quote-scanner.key-rate=16.5
```

Значение по умолчанию: **16.5%**

Ключевая ставка может быть изменена в любой момент и будет использоваться для всех новых расчетов.

### Исключения пар

Некоторые пары фьючерсов могут быть явно исключены из отображения, даже если они формально соответствуют критериям формирования пар. Исключения настраиваются в коде:

```javascript
// Исключаем пару RMZ5 - RIH6 (в любом порядке)
if ((nearTicker === 'RMZ5' && farTicker === 'RIH6') || 
    (nearTicker === 'RIH6' && farTicker === 'RMZ5')) {
    return; // Пропускаем эту пару
}
```

## Резюме

Сканер фьючерсов обеспечивает:

1. **Автоматическое формирование пар** на основе базовых активов
2. **Определение ближних и дальних фьючерсов** по кварталу экспирации
3. **Создание трех типов пар** для каждого базового актива
4. **Расчет спредов** с учетом лотности базового актива
5. **Расчет справедливого расхождения** на основе ключевой ставки и дней до экспирации
6. **Расчет дельты** как разницы между спредом и справедливым расхождением
7. **Отображение BID/ASK данных** с объемами для всех фьючерсов
8. **Предзагрузку всех пар** при открытии страницы
9. **Обновление в реальном времени** через WebSocket (без задержек)
10. **Независимую загрузку BID/ASK** данных от `last_price`
11. **Гибкие настройки отображения** для каждой таблицы
12. **Выделение и копирование данных** из таблиц
13. **Строгую проверку базовых активов** для предотвращения неправильных пар
14. **Исключения для специфических пар** (например, RMZ5-RIH6)

Сканер работает в любое время (включая выходные дни до 8:30) и может быть включен в тестовом режиме для работы вне торговых сессий.

## Связанная документация

- [QuoteScannerService](./QUOTE_SCANNER_SERVICE.md) — центральный сервис сканирования котировок
- [API Documentation](./API.md) — полная документация REST API
- [GRPC Limits](./GRPC_LIMITS.md) — лимиты gRPC подписок

