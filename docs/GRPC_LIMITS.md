# Лимиты gRPC подписок T-Invest API

## Обзор

Investment Data Scanner Service использует gRPC для получения потоковых рыночных данных от T-Invest API. При работе с подписками необходимо строго соблюдать установленные лимиты для обеспечения стабильной работы системы.

**Официальная документация:** [T-Invest API Limits](https://developer.tbank.ru/invest/intro/intro/limits)

## Основные лимиты

### 1. Количество активных stream-соединений

**Лимит:** От 16 до 64 одновременных соединений (зависит от лимитного грейда)

#### Лимитный грейд

Лимитный грейд пользователя определяется на основе активности за последние 30 дней:

- **Количество выставленных заявок**
- **Процент исполнения заявок**

Чем выше грейд, тем больше доступных ресурсов:

| Грейд | Максимум соединений |
|-------|---------------------|
| Низкий | 16 |
| Средний | 32-48 |
| Высокий | 64 |

#### Рекомендации

- Используйте минимально необходимое количество соединений
- Переиспользуйте существующие соединения вместо создания новых
- Мониторьте количество активных соединений

### 2. Количество подписок в одном stream-соединении

**Лимит:** Максимум 300 одновременных подписок в одном stream-соединении

#### Типы подписок

Лимит считается суммарно по всем трем типам данных:

1. **Свечи (Candles)** - исторические данные свечей
2. **Стаканы (OrderBook)** - данные стакана заявок
3. **Лента обезличенных сделок (Trades)** - данные о сделках

#### Пример расчета

Если у вас есть:
- 100 подписок на свечи
- 100 подписок на стаканы
- 100 подписок на сделки

**Итого:** 300 подписок (лимит достигнут)

#### Рекомендации

- Группируйте подписки по типам инструментов
- Используйте батчинг для оптимизации количества подписок
- Отслеживайте количество активных подписок в каждом соединении

### 3. Количество инструментов в одной подписке

**Лимит:** Максимум 200 инструментов в одном запросе подписки

#### Реализация в сервисе

В `MarketDataStreamingService` используется батчинг:

```java
// Лимит T-Invest API на количество инструментов в одной подписке
// Размер батча для подписки (акции, фьючерсы, индикативы отдельно)
private static final int SUBSCRIPTION_BATCH_SIZE = 200;

// Задержка между отправкой батчей подписки (мс)
private static final int BATCH_DELAY_MS = 100;
```

#### Алгоритм батчинга

1. Инструменты разбиваются на батчи по 200 штук
2. Батчи отправляются последовательно с задержкой 100 мс между ними
3. Разделение по типам инструментов (акции, фьючерсы, индикативы)

#### Пример

Если нужно подписаться на 500 инструментов:

```
Батч 1: инструменты 1-200   (отправка)
Задержка 100 мс
Батч 2: инструменты 201-400 (отправка)
Задержка 100 мс
Батч 3: инструменты 401-500 (отправка)
```

**Итого:** 3 батча, время подписки ~200 мс

### 4. Частота запросов подписки

**Лимит:** Максимум 100 запросов на подписку в минуту

#### Расчет частоты

При использовании батчинга:
- Батч = 1 запрос
- 100 батчей в минуту = максимум 20,000 инструментов в минуту (100 × 200)

#### Рекомендации

- Используйте батчинг для минимизации количества запросов
- Добавляйте задержки между батчами
- Не превышайте 100 запросов в минуту

## Конфигурация в сервисе

### MarketDataStreamingService

```java
@Service
public class MarketDataStreamingService {
    
    // Лимит T-Invest API на количество инструментов в одной подписке
    private static final int SUBSCRIPTION_BATCH_SIZE = 200;
    
    // Задержка между отправкой батчей подписки (мс)
    private static final int BATCH_DELAY_MS = 100;
    
    // Задержка переподключения (мс)
    private static final int RECONNECT_DELAY_MS = 1000;
}
```

### GrpcConfig

```java
@Configuration
public class GrpcConfig {
    
    @Bean
    public ManagedChannel channel() {
        return ManagedChannelBuilder
            .forAddress("invest-public-api.tinkoff.ru", 443)
            .useTransportSecurity()
            .keepAliveTime(30, TimeUnit.SECONDS)
            .keepAliveTimeout(5, TimeUnit.SECONDS)
            .keepAliveWithoutCalls(true)
            .maxInboundMessageSize(4 * 1024 * 1024) // 4MB
            .maxInboundMetadataSize(8 * 1024) // 8KB
            .enableRetry()
            .maxRetryAttempts(3)
            .build();
    }
}
```

## Рекомендации по оптимизации

### 1. Эффективное использование соединений

- ✅ Переиспользуйте существующие stream-соединения
- ✅ Группируйте подписки по типам данных
- ❌ Не создавайте новое соединение для каждой подписки

### 2. Батчинг подписок

- ✅ Разбивайте инструменты на батчи по 200 штук
- ✅ Добавляйте задержки между батчами (100 мс)
- ✅ Разделяйте по типам инструментов (акции, фьючерсы, индикативы)

### 3. Мониторинг лимитов

- ✅ Отслеживайте количество активных соединений
- ✅ Мониторьте количество подписок в каждом соединении
- ✅ Логируйте превышения лимитов

### 4. Обработка ошибок

- ✅ Реализуйте автоматическое переподключение
- ✅ Обрабатывайте ошибки превышения лимитов
- ✅ Используйте exponential backoff при переподключении

## Примеры использования

### Подписка на сделки (Trades)

```java
// Получение списка инструментов
List<String> instruments = getAllInstruments();

// Разбиение на батчи
List<List<String>> batches = splitIntoBatches(instruments, SUBSCRIPTION_BATCH_SIZE);

// Подписка с задержками
for (List<String> batch : batches) {
    subscribeToTrades(batch);
    Thread.sleep(BATCH_DELAY_MS);
}
```

### Подписка на стаканы (OrderBook)

```java
// Только акции для стаканов
List<String> shares = getShares();

// Разбиение на батчи
List<List<String>> batches = splitIntoBatches(shares, SUBSCRIPTION_BATCH_SIZE);

// Подписка с задержками
for (List<String> batch : batches) {
    subscribeToOrderBook(batch);
    Thread.sleep(BATCH_DELAY_MS);
}
```

## Обработка превышения лимитов

### Типичные ошибки

1. **Превышение лимита соединений**
   - Ошибка: `RESOURCE_EXHAUSTED`
   - Решение: Уменьшите количество соединений или увеличьте лимитный грейд

2. **Превышение лимита подписок**
   - Ошибка: `RESOURCE_EXHAUSTED`
   - Решение: Разделите подписки между несколькими соединениями

3. **Превышение частоты запросов**
   - Ошибка: `RESOURCE_EXHAUSTED`
   - Решение: Увеличьте задержки между запросами

### Стратегия переподключения

```java
private void reconnectWithBackoff() {
    int delay = RECONNECT_DELAY_MS;
    int maxDelay = 60000; // 1 минута
    
    while (isRunning.get() && !isConnected.get()) {
        try {
            startLastPriceStream();
            if (isConnected.get()) {
                break;
            }
        } catch (Exception e) {
            log.error("Reconnection failed, retrying in {} ms", delay, e);
        }
        
        try {
            Thread.sleep(delay);
            delay = Math.min(delay * 2, maxDelay); // Exponential backoff
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            break;
        }
    }
}
```

## Мониторинг и метрики

### Рекомендуемые метрики

1. **Количество активных соединений**
   - `grpc_connections_active`
   - Алерт при приближении к лимиту

2. **Количество подписок**
   - `grpc_subscriptions_total`
   - Разбивка по типам (candles, orderbook, trades)

3. **Частота запросов**
   - `grpc_requests_per_minute`
   - Алерт при превышении 100 запросов/минуту

4. **Ошибки превышения лимитов**
   - `grpc_errors_resource_exhausted`
   - Критический алерт

### Пример Prometheus метрик

```prometheus
# Количество активных gRPC соединений
grpc_connections_active{service="market_data"} 1

# Количество подписок по типам
grpc_subscriptions_total{type="trades"} 150
grpc_subscriptions_total{type="orderbook"} 50
grpc_subscriptions_total{type="candles"} 100

# Частота запросов
rate(grpc_requests_total[1m]) 45.2

# Ошибки превышения лимитов
grpc_errors_total{error="RESOURCE_EXHAUSTED"} 0
```

## Часто задаваемые вопросы

### Q: Можно ли превысить лимит в 200 инструментов в одной подписке?

**A:** Нет, T-Invest API вернет ошибку `INVALID_ARGUMENT` при попытке подписаться на более чем 200 инструментов в одном запросе.

### Q: Как увеличить лимитный грейд?

**A:** Лимитный грейд определяется автоматически на основе вашей активности за последние 30 дней. Увеличьте количество успешных торговых операций.

### Q: Что делать при превышении лимита подписок?

**A:** Разделите подписки между несколькими stream-соединениями. Каждое соединение может иметь до 300 подписок.

### Q: Можно ли использовать один stream-соединение для всех типов данных?

**A:** Да, но помните, что лимит в 300 подписок считается суммарно по всем типам данных.

### Q: Как оптимизировать частоту запросов?

**A:** Используйте батчинг - группируйте инструменты в батчи по 200 штук и добавляйте задержки между батчами.

## Ссылки

- [T-Invest API Документация](https://developer.tbank.ru/invest/intro/intro)
- [T-Invest API Лимиты](https://developer.tbank.ru/invest/intro/intro/limits)
- [gRPC Best Practices](https://grpc.io/docs/guides/performance/)

---

**Последнее обновление:** 2024-01-15  
**Версия:** 1.0.0

